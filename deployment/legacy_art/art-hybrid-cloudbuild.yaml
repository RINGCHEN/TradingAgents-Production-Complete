# ARTç³»çµ±æ··åˆéƒ¨ç½² Cloud Build CI/CDé…ç½®
# DevOps Engineer å¢¨å­ - æœ¬åœ°åˆ°é›²ç«¯å®Œæ•´è‡ªå‹•åŒ–ç®¡ç·š

steps:
  # æ­¥é©Ÿ 1: ç’°å¢ƒæª¢æŸ¥å’Œæº–å‚™
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ ARTç³»çµ±æ··åˆéƒ¨ç½²ç®¡ç·šå•Ÿå‹•"
        echo "æ§‹å»ºID: $BUILD_ID"
        echo "æäº¤SHA: $COMMIT_SHA"
        echo "åˆ†æ”¯: $BRANCH_NAME"
        echo "é …ç›®ID: $PROJECT_ID"
        
        # æª¢æŸ¥å¿…è¦çš„APIæ˜¯å¦å•Ÿç”¨
        gcloud services list --enabled --format="value(config.name)" | grep -E "(run|container|artifactregistry)" || {
          echo "âŒ å¿…è¦çš„GCPæœå‹™æœªå•Ÿç”¨"
          exit 1
        }
        
        echo "âœ… ç’°å¢ƒæª¢æŸ¥å®Œæˆ"
    id: 'environment-check'

  # æ­¥é©Ÿ 2: ä»£ç¢¼å“è³ªå’Œå®‰å…¨æƒæ
  - name: 'python:3.11-slim'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ” åŸ·è¡Œä»£ç¢¼å“è³ªæª¢æŸ¥..."
        pip install flake8 black isort bandit safety
        
        # ä»£ç¢¼æ ¼å¼æª¢æŸ¥
        flake8 tradingagents/ --max-line-length=100 --ignore=E203,W503
        black --check tradingagents/
        isort --check-only tradingagents/
        
        # å®‰å…¨æƒæ
        bandit -r tradingagents/ -f json -o bandit-report.json || true
        safety check -r requirements.txt || true
        
        echo "âœ… ä»£ç¢¼å“è³ªæª¢æŸ¥å®Œæˆ"
    id: 'code-quality-scan'

  # æ­¥é©Ÿ 3: æ§‹å»ºGPUè¨“ç·´æ˜ åƒ
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-f'
      - 'deployment/Dockerfile.gpu-training'
      - '-t'
      - 'asia-east1-docker.pkg.dev/$PROJECT_ID/art-docker-repo/art-gpu-training:$COMMIT_SHA'
      - '-t'
      - 'asia-east1-docker.pkg.dev/$PROJECT_ID/art-docker-repo/art-gpu-training:latest'
      - '.'
    id: 'build-gpu-training-image'

  # æ­¥é©Ÿ 4: æ§‹å»ºæ¨ç†æœå‹™æ˜ åƒ
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-f'
      - 'deployment/Dockerfile.inference'
      - '-t'
      - 'asia-east1-docker.pkg.dev/$PROJECT_ID/art-docker-repo/art-inference:$COMMIT_SHA'
      - '-t'
      - 'asia-east1-docker.pkg.dev/$PROJECT_ID/art-docker-repo/art-inference:latest'
      - '.'
    id: 'build-inference-image'

  # æ­¥é©Ÿ 5: å®¹å™¨å®‰å…¨æƒæ
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ”’ åŸ·è¡Œå®¹å™¨å®‰å…¨æƒæ..."
        
        # æƒæGPUè¨“ç·´æ˜ åƒ
        gcloud container images scan \
          asia-east1-docker.pkg.dev/$PROJECT_ID/art-docker-repo/art-gpu-training:$COMMIT_SHA \
          --format='table(response.vulnerabilities.vulnerability.severity.count():label=COUNT,response.vulnerabilities.vulnerability.severity.name():label=SEVERITY)' || true
        
        # æƒææ¨ç†æ˜ åƒ
        gcloud container images scan \
          asia-east1-docker.pkg.dev/$PROJECT_ID/art-docker-repo/art-inference:$COMMIT_SHA \
          --format='table(response.vulnerabilities.vulnerability.severity.count():label=COUNT,response.vulnerabilities.vulnerability.severity.name():label=SEVERITY)' || true
        
        echo "âœ… å®¹å™¨å®‰å…¨æƒæå®Œæˆ"
    id: 'container-security-scan'

  # æ­¥é©Ÿ 6: æ¨é€æ˜ åƒåˆ° Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'asia-east1-docker.pkg.dev/$PROJECT_ID/art-docker-repo/art-gpu-training:$COMMIT_SHA'
    id: 'push-gpu-training-image'

  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'asia-east1-docker.pkg.dev/$PROJECT_ID/art-docker-repo/art-inference:$COMMIT_SHA'
    id: 'push-inference-image'

  # æ­¥é©Ÿ 7: æ¨é€latestæ¨™ç±¤
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'asia-east1-docker.pkg.dev/$PROJECT_ID/art-docker-repo/art-gpu-training:latest'
    id: 'push-gpu-training-latest'

  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - 'asia-east1-docker.pkg.dev/$PROJECT_ID/art-docker-repo/art-inference:latest'
    id: 'push-inference-latest'

  # æ­¥é©Ÿ 8: éƒ¨ç½²åˆ°GKE Stagingç’°å¢ƒ
  - name: 'gcr.io/cloud-builders/kubectl'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ éƒ¨ç½²åˆ°GKE Stagingç’°å¢ƒ..."
        
        # ç²å–GKEæ†‘è­‰
        gcloud container clusters get-credentials art-gpu-cluster --region=asia-east1
        
        # æ›´æ–°Kuberneteséƒ¨ç½²æ–‡ä»¶ä¸­çš„æ˜ åƒæ¨™ç±¤
        sed -i "s|IMAGE_TAG|$COMMIT_SHA|g" deployment/k8s/art-staging.yaml
        
        # éƒ¨ç½²åˆ°Kubernetes
        kubectl apply -f deployment/k8s/art-staging.yaml
        
        # ç­‰å¾…éƒ¨ç½²å°±ç·’
        kubectl rollout status deployment/art-gpu-training-staging -n art-staging --timeout=300s
        kubectl rollout status deployment/art-inference-staging -n art-staging --timeout=300s
        
        echo "âœ… GKE Stagingéƒ¨ç½²å®Œæˆ"
    id: 'deploy-gke-staging'
    env:
      - 'CLOUDSDK_COMPUTE_REGION=asia-east1'
      - 'CLOUDSDK_CONTAINER_CLUSTER=art-gpu-cluster'

  # æ­¥é©Ÿ 9: æ¨¡å‹åŒæ­¥æª¢æŸ¥
  - name: 'python:3.11-slim'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ”„ æª¢æŸ¥æ¨¡å‹åŒæ­¥ç‹€æ…‹..."
        pip install google-cloud-storage mlflow requests
        
        python3 << 'EOF'
        import os
        from google.cloud import storage
        import requests
        import json
        
        # æª¢æŸ¥æ¨¡å‹å­˜å„²æ¡¶
        client = storage.Client()
        bucket = client.bucket(f"{os.environ['PROJECT_ID']}-art-models")
        blobs = list(bucket.list_blobs(prefix="models/"))
        
        print(f"æ¨¡å‹å­˜å„²æ¡¶ä¸­ç™¼ç¾ {len(blobs)} å€‹æ¨¡å‹æ–‡ä»¶")
        
        # æª¢æŸ¥MLFlowæœå‹™ç‹€æ…‹
        staging_url = "http://art-mlflow-staging.art-staging.svc.cluster.local:5000"
        try:
            response = requests.get(f"{staging_url}/api/2.0/mlflow/experiments/list", timeout=10)
            if response.status_code == 200:
                print("âœ… MLFlowæœå‹™æ­£å¸¸é‹è¡Œ")
            else:
                print(f"âš ï¸ MLFlowæœå‹™ç•°å¸¸: {response.status_code}")
        except Exception as e:
            print(f"âš ï¸ ç„¡æ³•é€£æ¥MLFlowæœå‹™: {e}")
        EOF
        
        echo "âœ… æ¨¡å‹åŒæ­¥æª¢æŸ¥å®Œæˆ"
    id: 'model-sync-check'

  # æ­¥é©Ÿ 10: é›†æˆæ¸¬è©¦
  - name: 'python:3.11-slim'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ§ª åŸ·è¡Œé›†æˆæ¸¬è©¦..."
        pip install pytest requests kubernetes
        
        # ç²å–Stagingæœå‹™ç«¯é»
        gcloud container clusters get-credentials art-gpu-cluster --region=asia-east1
        
        # é‹è¡Œé›†æˆæ¸¬è©¦
        export STAGING_NAMESPACE=art-staging
        export COMMIT_SHA=$COMMIT_SHA
        pytest tests/integration/test_art_hybrid.py -v --tb=short
        
        echo "âœ… é›†æˆæ¸¬è©¦å®Œæˆ"
    id: 'integration-tests'
    env:
      - 'CLOUDSDK_COMPUTE_REGION=asia-east1'
      - 'CLOUDSDK_CONTAINER_CLUSTER=art-gpu-cluster'

  # æ­¥é©Ÿ 11: æ•ˆèƒ½åŸºæº–æ¸¬è©¦
  - name: 'loadimpact/k6:latest'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "âš¡ åŸ·è¡Œæ•ˆèƒ½åŸºæº–æ¸¬è©¦..."
        
        # ç²å–æ¨ç†æœå‹™ç«¯é»
        kubectl get service art-inference-staging -n art-staging -o jsonpath='{.status.loadBalancer.ingress[0].ip}' > inference_ip.txt
        INFERENCE_IP=$(cat inference_ip.txt)
        
        cat > performance-test.js << 'EOF'
        import http from 'k6/http';
        import { check, sleep } from 'k6';
        
        export let options = {
          stages: [
            { duration: '2m', target: 10 },   // ç·©æ…¢å¢åŠ åˆ°10å€‹ç”¨æˆ¶
            { duration: '5m', target: 10 },   // ç¶­æŒ10å€‹ç”¨æˆ¶
            { duration: '2m', target: 20 },   // å¢åŠ åˆ°20å€‹ç”¨æˆ¶
            { duration: '5m', target: 20 },   // ç¶­æŒ20å€‹ç”¨æˆ¶
            { duration: '2m', target: 0 },    // ç·©æ…¢é™åˆ°0å€‹ç”¨æˆ¶
          ],
        };
        
        export default function() {
          // å¥åº·æª¢æŸ¥
          let healthResponse = http.get(`http://${__ENV.INFERENCE_IP}:8080/health`);
          check(healthResponse, {
            'health check status is 200': (r) => r.status === 200,
            'health check response time < 100ms': (r) => r.timings.duration < 100,
          });
          
          // æ¨ç†APIæ¸¬è©¦
          let payload = JSON.stringify({
            text: "AAPLè‚¡ç¥¨ä»Šæ—¥ä¸Šæ¼²3%ï¼Œå¸‚å ´å°å…¶æ–°ç”¢å“ç™¼å¸ƒåæ‡‰ç©æ¥µ",
            model: "art-sentiment-v1"
          });
          
          let inferenceResponse = http.post(`http://${__ENV.INFERENCE_IP}:8080/predict`, payload, {
            headers: { 'Content-Type': 'application/json' }
          });
          
          check(inferenceResponse, {
            'inference status is 200': (r) => r.status === 200,
            'inference response time < 2s': (r) => r.timings.duration < 2000,
            'inference has result': (r) => JSON.parse(r.body).prediction !== undefined,
          });
          
          sleep(1);
        }
        EOF
        
        k6 run --env INFERENCE_IP="$INFERENCE_IP" performance-test.js || true
        
        echo "âœ… æ•ˆèƒ½åŸºæº–æ¸¬è©¦å®Œæˆ"
    id: 'performance-benchmark'

  # æ­¥é©Ÿ 12: ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²ï¼ˆåƒ…é™mainåˆ†æ”¯ï¼‰
  - name: 'gcr.io/cloud-builders/kubectl'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "$BRANCH_NAME" = "main" ]; then
          echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ..."
          
          # æ›´æ–°ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²æ–‡ä»¶
          sed -i "s|IMAGE_TAG|$COMMIT_SHA|g" deployment/k8s/art-production.yaml
          
          # éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
          kubectl apply -f deployment/k8s/art-production.yaml
          
          # ç­‰å¾…éƒ¨ç½²å°±ç·’
          kubectl rollout status deployment/art-gpu-training-prod -n art-production --timeout=600s
          kubectl rollout status deployment/art-inference-prod -n art-production --timeout=600s
          
          # æ›´æ–°Cloud Runæ¨ç†æœå‹™
          gcloud run deploy art-inference-service \
            --image=asia-east1-docker.pkg.dev/$PROJECT_ID/art-docker-repo/art-inference:$COMMIT_SHA \
            --platform=managed \
            --region=asia-east1 \
            --port=8080 \
            --memory=8Gi \
            --cpu=4 \
            --timeout=300s \
            --concurrency=100 \
            --max-instances=10 \
            --min-instances=1 \
            --set-env-vars="ENVIRONMENT=production" \
            --quiet
          
          echo "âœ… ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å®Œæˆ"
        else
          echo "â„¹ï¸ émainåˆ†æ”¯ï¼Œè·³éç”Ÿç”¢éƒ¨ç½²"
        fi
    id: 'deploy-production'
    env:
      - 'CLOUDSDK_COMPUTE_REGION=asia-east1'
      - 'CLOUDSDK_CONTAINER_CLUSTER=art-gpu-cluster'

  # æ­¥é©Ÿ 13: ç”Ÿç”¢ç’°å¢ƒå¥åº·æª¢æŸ¥
  - name: 'curlimages/curl:latest'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        if [ "$BRANCH_NAME" = "main" ]; then
          echo "ğŸ” åŸ·è¡Œç”Ÿç”¢ç’°å¢ƒå¥åº·æª¢æŸ¥..."
          
          # æª¢æŸ¥Cloud Runæœå‹™
          PROD_URL=$(gcloud run services describe art-inference-service --region=asia-east1 --format="value(status.url)")
          echo "ç”Ÿç”¢æ¨ç†æœå‹™URL: $PROD_URL"
          
          # ç­‰å¾…æœå‹™å•Ÿå‹•
          sleep 60
          
          # å¥åº·æª¢æŸ¥
          curl -f "$PROD_URL/health" --connect-timeout 10 --max-time 30
          echo "âœ… ç”Ÿç”¢ç’°å¢ƒå¥åº·æª¢æŸ¥é€šé"
          
          # å¿«é€Ÿæ¨ç†æ¸¬è©¦
          curl -X POST "$PROD_URL/predict" \
            -H "Content-Type: application/json" \
            -d '{"text":"æ¸¬è©¦æ¨ç†æœå‹™","model":"art-sentiment-v1"}' \
            --connect-timeout 10 --max-time 30
          echo "âœ… ç”Ÿç”¢æ¨ç†æœå‹™æ­£å¸¸"
        else
          echo "â„¹ï¸ émainåˆ†æ”¯ï¼Œè·³éç”Ÿç”¢å¥åº·æª¢æŸ¥"
        fi
    id: 'production-health-check'

  # æ­¥é©Ÿ 14: éƒ¨ç½²é€šçŸ¥å’Œç›£æ§è¨­ç½®
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ“Š è¨­ç½®ç›£æ§å’Œå‘Šè­¦..."
        
        # å‰µå»ºè‡ªå®šç¾©æŒ‡æ¨™
        gcloud logging metrics create art_training_errors \
          --description="ARTè¨“ç·´éŒ¯èª¤è¨ˆæ•¸" \
          --log-filter='resource.type="k8s_container" AND resource.labels.namespace_name="art-production" AND severity="ERROR"' || true
        
        gcloud logging metrics create art_inference_latency \
          --description="ARTæ¨ç†å»¶é²" \
          --log-filter='resource.type="cloud_run_revision" AND resource.labels.service_name="art-inference-service"' || true
        
        echo "ğŸ“§ ç™¼é€éƒ¨ç½²é€šçŸ¥..."
        if [ "$BRANCH_NAME" = "main" ]; then
          PROD_URL=$(gcloud run services describe art-inference-service --region=asia-east1 --format="value(status.url)")
          echo "âœ… ARTç³»çµ±ç”Ÿç”¢éƒ¨ç½²æˆåŠŸ"
          echo "ğŸ”— æ¨ç†æœå‹™URL: $PROD_URL"
          echo "ğŸ“Š ç‰ˆæœ¬: $COMMIT_SHA"
          echo "ğŸŒ¿ åˆ†æ”¯: $BRANCH_NAME"
          echo "ğŸ—ï¸ æ§‹å»ºID: $BUILD_ID"
        else
          echo "âœ… ARTç³»çµ±Stagingéƒ¨ç½²æˆåŠŸ"
          echo "ğŸ“Š ç‰ˆæœ¬: $COMMIT_SHA"
          echo "ğŸŒ¿ åˆ†æ”¯: $BRANCH_NAME"
          echo "ğŸ—ï¸ æ§‹å»ºID: $BUILD_ID"
        fi
        
        echo "âœ… ç›£æ§è¨­ç½®å®Œæˆ"
    id: 'monitoring-and-notification'

# æ§‹å»ºé¸é …
options:
  machineType: 'E2_HIGHCPU_32'  # ä½¿ç”¨é«˜é…ç½®æ©Ÿå™¨
  timeout: '3600s'              # 1å°æ™‚è¶…æ™‚
  logging: 'CLOUD_LOGGING_ONLY'
  
  # ä¸¦è¡Œæ§‹å»ºå„ªåŒ–
  env:
    - 'DOCKER_BUILDKIT=1'
    - 'BUILDKIT_PROGRESS=plain'

# è§¸ç™¼å™¨é…ç½®èªªæ˜:
# - æ¨é€åˆ°ä»»ä½•åˆ†æ”¯è§¸ç™¼å®Œæ•´CI/CDç®¡ç·š
# - mainåˆ†æ”¯è‡ªå‹•éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
# - å…¶ä»–åˆ†æ”¯åƒ…éƒ¨ç½²åˆ°stagingç’°å¢ƒ
# - æ”¯æ´æ‰‹å‹•è§¸ç™¼å’Œå®šæ™‚æ§‹å»º

# å¿…è¦çš„IAMæ¬Šé™ï¼š
# - Kubernetes Engine Admin
# - Cloud Run Admin
# - Storage Admin
# - Secret Manager Admin
# - Container Analysis Admin
# - Monitoring Admin
# - Logging Admin